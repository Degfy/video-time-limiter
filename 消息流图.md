# 视频时长限制器消息流图

## 系统架构概述

视频时长限制器是一个Chrome浏览器扩展，由三个主要组件组成： - **Content
Script** (content.js) - 在网页中运行，监测视频播放 - **Background
Script** (background.js) - 后台服务工作者，处理数据存储和业务逻辑 -
**Popup** (popup.js) - 扩展设置界面

## 消息流图

``` mermaid
sequenceDiagram
    participant User as 用户
    participant Popup as Popup界面<br/>(popup.js)
    participant Background as Background脚本<br/>(background.js)
    participant Content as Content脚本<br/>(content.js)
    participant Storage as Chrome存储
    participant Server as 远程服务器
    participant WebPage as 网页视频

    Note over User,WebPage: 扩展初始化流程
    
    User->>Popup: 点击扩展图标
    Popup->>Background: chrome.runtime.sendMessage({action: 'getConfig'})
    Background->>Storage: chrome.storage.local.get()
    Storage-->>Background: 返回配置数据
    Background-->>Popup: 返回配置信息
    Popup->>Popup: updateUI() 更新界面显示
    
    Note over User,WebPage: 配置更新流程
    
    User->>Popup: 修改设置并保存
    Popup->>Background: chrome.runtime.sendMessage({action: 'updateConfig', config})
    Background->>Storage: chrome.storage.local.set(updates)
    
    alt 远程模式
        Background->>Server: PUT /api/v1/videos/{userId}<br/>同步配置到服务器
        Server-->>Background: 响应结果
    end
    
    Background->>Popup: chrome.runtime.sendMessage({type: 'configUpdated'})
    Background->>Storage: 触发storage.onChanged事件
    Storage->>Background: 检测到配置变化
    Background->>Background: 获取最新完整配置(getLocalConfig)
    Background->>Content: chrome.tabs.sendMessage({action: 'configUpdated', config})
    Content->>Content: 被动接收完整配置更新，无需主动请求
    
    Note over User,WebPage: 视频监测和时长统计流程
    
    Content->>WebPage: 监听DOM变化和视频事件
    WebPage->>Content: video.play 事件
    Content->>Content: handleVideoPlay() 开始计时
    
    WebPage->>Content: video.pause/ended 事件
    Content->>Content: handleVideoPause() 停止计时
    Content->>Background: chrome.runtime.sendMessage({action: 'addWatchTime', time})
    
    Background->>Background: handleAddWatchTime() 使用本地配置处理时长累加
    Background->>Storage: chrome.storage.local.set() 更新本地时长
    
    alt 远程模式
        Background->>Background: 累积观看时长到accumulatedWatchTime
        alt 达到30秒同步间隔
            Background->>Server: POST /api/v1/videos/{userId}<br/>批量同步累积时长
            Server-->>Background: 返回最新数据{watchTime, limitTime, customMessage}
            Background->>Storage: 利用服务器返回数据更新本地存储
        end
    end
    
    Background-->>Content: 返回{watchTime, isOverLimit, customMessage}
    
    alt 超过时间限制
        Content->>Content: pauseAllVideos() 自动暂停所有视频
        Content->>Content: showWarning() 显示警告弹窗
        Content->>WebPage: 在页面上显示全屏警告
        User->>WebPage: 点击关闭警告
        WebPage->>Content: 关闭警告事件
        Content->>Content: removeWarning() 移除警告
    end
    
    Background->>Storage: 触发storage.onChanged事件
    Storage->>Background: 检测到数据变化
    Background->>Background: 获取最新完整配置(getLocalConfig)
    Background->>Content: chrome.tabs.sendMessage({action: 'configUpdated', config})
    Background->>Popup: chrome.runtime.sendMessage({type: 'configUpdated', config})
    Content->>Content: 被动接收配置更新，无需主动请求
    Popup->>Popup: updateDisplay() 更新时长显示
    
    Note over User,WebPage: 服务器状态检查流程
    
    User->>Popup: 点击"检查服务器状态"
    Popup->>Background: chrome.runtime.sendMessage({action: 'checkServerStatus'})
    Background->>Server: GET /api/health-check
    Server-->>Background: 健康检查响应
    Background-->>Popup: 返回服务器状态
    Popup->>User: 显示连接状态
```

## 详细消息类型说明

### 1. Popup → Background 消息

  消息类型              参数            说明
  --------------------- --------------- ------------------------------------
  `getConfig`           无              获取当前配置信息
  `updateConfig`        `{config}`      更新配置（时间限制、服务器地址等）
  `checkServerStatus`   `{serverUrl}`   检查远程服务器连接状态

### 2. Content → Background 消息

  消息类型         参数       说明
  ---------------- ---------- --------------------------
  `addWatchTime`   `{time}`   添加视频观看时长（毫秒）

  注：Content Script不再主动请求配置，改为被动接收Background推送的配置更新

### 3. Background → Popup/Content 消息

  消息类型          参数                          说明
  ----------------- ----------------------------- ----------------
  `configUpdated`   `{config, changes}`          通知配置已更新，包含完整配置和变化信息

### 4. Background → Content 消息

  ------------------------------------------------------------------------------------------------
  消息类型                      参数                说明
  ----------------------------- ------------------- ----------------------------------------------
  `configUpdated`               `{config, changes}` 主动推送完整配置和变化信息（通过chrome.storage.onChanged）

  ------------------------------------------------------------------------------------------------

## 关键事件流程

### 视频播放监测流程

1.  **DOM监听**: Content Script使用MutationObserver监听页面DOM变化
2.  **视频发现**: 自动发现新添加的`<video>`元素
3.  **事件绑定**: 为每个视频元素绑定play/pause/ended/timeupdate事件
4.  **时长计算**: 记录播放开始时间，暂停时计算观看时长
5.  **数据上报**: 将时长数据发送给Background Script

### 数据存储策略

-   **本地模式**: 数据存储在Chrome本地存储中
-   **远程模式**: 数据同时存储在本地和远程服务器，采用累积批量同步机制
-   **每日重置**: 每天自动重置观看时长计数器
-   **数据同步**: 服务器返回数据用于更新本地存储，确保数据一致性
-   **本地优先**: handleAddWatchTime使用本地配置，避免频繁服务器请求

### 警告显示机制

-   当累计观看时长超过设定限制时触发
-   **自动暂停**: 显示警告前自动暂停所有正在播放的视频
-   在页面上显示全屏模态警告框
-   用户关闭警告后，如果继续播放视频，10秒后再次显示警告
-   警告内容可自定义，支持加粗红色显示

### 配置同步机制

-   **被动更新**: Content Script不再主动请求配置，改为被动接收Background推送
-   **完整配置推送**: Background Script通过storage.onChanged监听数据变化，主动推送完整配置
-   **实时同步**: Popup界面和Content Script实时接收配置更新
-   **双重通知**: 通过chrome.runtime.sendMessage和chrome.tabs.sendMessage确保所有组件收到更新
-   **远程同步**: 远程模式下自动同步到服务器，利用返回数据更新本地存储

## 技术特点

1.  **异步消息传递**: 使用Chrome Extension API的消息传递机制
2.  **事件驱动**: 基于DOM事件和Chrome扩展事件
3.  **数据持久化**: 支持本地存储和远程服务器双重备份
4.  **被动数据流**: Content Script被动接收配置更新，减少主动请求
5.  **批量同步**: 远程模式采用累积批量同步，提高性能
6.  **本地优先**: 观看时间处理优先使用本地数据，避免频繁服务器请求
7.  **主动推送**: Background Script主动推送完整配置到所有组件
8.  **自动暂停**: 超时警告前自动暂停视频播放
9.  **错误处理**: 完善的错误处理和降级机制
